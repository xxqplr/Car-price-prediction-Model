import pandas as pd
from sklearn.preprocessing import LabelEncoder
from sklearn.model_selection import train_test_split
from sklearn.ensemble import RandomForestRegressor
from sklearn.linear_model import LinearRegression
from sklearn.metrics import mean_squared_error, r2_score, mean_absolute_error
import streamlit as st
import pickle

# --- Load cleaned dataset ---
df_train = pd.read_csv("temp_file.csv")  # your processed CSV

# --- Encode categorical features ---
le_trans = LabelEncoder()
df_train["Trans"] = le_trans.fit_transform(df_train["Trans"])

le_brand = LabelEncoder()
df_train["brand"] = le_brand.fit_transform(df_train["brand"])

# --- Train models ---
X = df_train[["Trans", "Power", "Year", "brand"]]
y = df_train["Price"]

x_train, x_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# Random Forest
rf_model = RandomForestRegressor(n_estimators=200, random_state=42)
rf_model.fit(x_train, y_train)

# Linear Regression
lin_model = LinearRegression()
lin_model.fit(x_train, y_train)

# --- Evaluate models ---
y_pred_rf = rf_model.predict(x_test)
y_pred_lin = lin_model.predict(x_test)

st.write("### Model Evaluation")
st.write("Random Forest:")
st.write(f"MSE: {mean_squared_error(y_test, y_pred_rf):,.0f}")
st.write(f"R2: {r2_score(y_test, y_pred_rf):.2f}")
st.write(f"MAE: {mean_absolute_error(y_test, y_pred_rf):,.0f}")

st.write("Linear Regression:")
st.write(f"MSE: {mean_squared_error(y_test, y_pred_lin):,.0f}")
st.write(f"R2: {r2_score(y_test, y_pred_lin):.2f}")
st.write(f"MAE: {mean_absolute_error(y_test, y_pred_lin):,.0f}")

# --- Streamlit UI for new prediction ---
st.title("ðŸš— Car Price Predictor")

brand_input = st.selectbox("Select Brand:", df_train["brand"].unique())
trans_input = st.selectbox("Transmission:", ["Automatic", "Manual"])
power_input = st.number_input("Power (CC):", min_value=500, max_value=5000, value=1600)
year_input = st.number_input("Year:", min_value=2000, max_value=2025, value=2023)

if st.button("Predict Price"):
    new_car = pd.DataFrame({
        "Trans": [trans_input],
        "Power": [power_input],
        "Year": [year_input],
        "brand": [brand_input]
    })
    # Encode new input
    new_car["Trans"] = le_trans.transform(new_car["Trans"])
    new_car["brand"] = le_brand.transform(new_car["brand"])

    # Make predictions
    price_rf = rf_model.predict(new_car)[0]
    price_lin = lin_model.predict(new_car)[0]

    st.success(f"Random Forest Prediction: {price_rf:,.0f} JD")
    st.info(f"Linear Regression Prediction: {price_lin:,.0f} JD")
